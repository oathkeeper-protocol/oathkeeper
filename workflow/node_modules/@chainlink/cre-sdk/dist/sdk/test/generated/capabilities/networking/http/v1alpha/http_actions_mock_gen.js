import { fromJson } from '@bufbuild/protobuf';
import { anyPack, anyUnpack } from '@bufbuild/protobuf/wkt';
import { RequestSchema, ResponseSchema, } from '../../../../../../../generated/capabilities/networking/http/v1alpha/client_pb';
import { __getTestMockInstance, __setTestMockInstance, registerTestCapability, } from '../../../../../../testutils/test-runtime';
/**
 * Mock for ClientCapability. Use testInstance() to obtain an instance; do not construct directly.
 * Set per-method properties (e.g. performAction) to define return values. If a method is invoked without a handler set, an error is thrown.
 */
export class HttpActionsMock {
    static CAPABILITY_ID = 'http-actions@1.0.0-alpha';
    /** Set to define the return value for SendRequest. May return a plain object (ResponseJson) or the message type. */
    sendRequest;
    constructor() {
        const self = this;
        const qualifiedId = HttpActionsMock.CAPABILITY_ID;
        try {
            registerTestCapability(qualifiedId, (req) => {
                switch (req.method) {
                    case 'SendRequest': {
                        const input = anyUnpack(req.payload, RequestSchema);
                        const handler = self.sendRequest;
                        if (typeof handler !== 'function')
                            throw new Error("SendRequest: no implementation provided; set the mock's sendRequest property to define the return value.");
                        const raw = handler(input);
                        const output = raw && typeof raw.$typeName === 'string'
                            ? raw
                            : fromJson(ResponseSchema, raw);
                        return { response: { case: 'payload', value: anyPack(ResponseSchema, output) } };
                    }
                    default:
                        return { response: { case: 'error', value: `unknown method ${req.method}` } };
                }
            });
        }
        catch {
            throw new Error("Capability mocks must be used within the CRE test framework's test() method.");
        }
    }
    /**
     * Returns the mock instance for this capability.
     * Multiple calls with the same arguments return the same instance.
     * Must be called within the test framework's test() method.
     */
    static testInstance() {
        const qualifiedId = HttpActionsMock.CAPABILITY_ID;
        let instance = __getTestMockInstance(qualifiedId);
        if (!instance) {
            instance = new HttpActionsMock();
            __setTestMockInstance(qualifiedId, instance);
        }
        return instance;
    }
}
